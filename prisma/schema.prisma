generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  STAFF
  CUSTOMER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  ONLINE
}

enum StockType {
  ADD
  REMOVE
  ADJUSTMENT
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?
  role      Role     @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer      Customer?
  staff         Staff?
  notifications Notification[]
}

model Customer {
  id            String  @id @default(uuid())
  userId        String  @unique
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  phone         String?
  address       String?
  loyaltyPoints Int     @default(0)

  bookings Booking[]
  invoices Invoice[]

  membershipId String?
  membership   Membership? @relation(fields: [membershipId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Staff {
  id             String  @id @default(uuid())
  userId         String  @unique
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  phone          String?
  specialization String?
  isActive       Boolean @default(true)
  commissionRate Decimal @default(0)

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Service {
  id          String  @id @default(uuid())
  name        String
  description String?
  price       Decimal
  duration    Int
  category    String  @default("General")
  imageUrl    String?
  isActive    Boolean @default(true)

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id        String        @id @default(uuid())
  date      DateTime
  startTime DateTime
  endTime   DateTime
  status    BookingStatus @default(PENDING)
  notes     String?

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  staffId String?
  staff   Staff?  @relation(fields: [staffId], references: [id])

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  invoice Invoice?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([customerId])
  @@index([staffId])
}

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique @default(cuid()) // Placeholder, will be replaced by custom logic
  bookingId     String?  @unique
  booking       Booking? @relation(fields: [bookingId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  items       Json?
  subtotal    Decimal  @default(0)
  taxAmount   Decimal  @default(0) // GST 18%
  totalAmount Decimal
  status      PaymentStatus @default(PENDING)

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id        String  @id @default(uuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  amount        Decimal
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?

  createdAt DateTime @default(now())
}

model Membership {
  id             String  @id @default(uuid())
  name           String
  price          Decimal
  durationMonths Int
  discountPct    Decimal
  description    String?
  isActive       Boolean @default(true)

  customers Customer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Offer {
  id          String   @id @default(uuid())
  code        String   @unique
  description String?
  discountPct Decimal?
  flatAmount  Decimal?
  validFrom   DateTime
  validUntil  DateTime
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id                String  @id @default(uuid())
  name              String
  brand             String?
  price             Decimal
  sku               String  @unique
  description       String?
  stockQuantity     Int     @default(0)
  lowStockThreshold Int     @default(5)

  stock Stock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Stock {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  type     StockType
  notes    String?

  createdAt DateTime @default(now())
}

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  title   String
  message String
  isRead  Boolean @default(false)
  type    String

  createdAt DateTime @default(now())
}
